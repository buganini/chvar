<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style type="text/css">
.hl{
	border: solid 1px #f00;
}
</style>
<script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
<script type="text/javascript">
function mkimg(s,hl,t){
	s=s.replace(/^[ 0]*/g,'').replace(/ *$/g,'');
	if(t){
		alt='['+t+']';
		title=t;
	}else{
		alt=title='';
	}
	if(s){
		return '<img src="http://www.unicode.org/cgi-bin/refglyph?24-'+s+'" alt="'+alt+'" title="'+title+'"'+(hl?' class="hl"':'')+' />';
	}else{
		return '';
	}
}

function dispGlyph(){
	var s=$('#text').val();
	var a=s.split('\n');
	var img='';
	var x=new Array();
	for(var i=0;i<a.length;++i){
		x[i]=a[i].replace(/[^0-9a-f]/ig,'');
		hl=0;
		if(i && x[i]==x[0]){
			hl=1;
		}
		img+=mkimg(x[i],hl);
	}
	$('#glyph').html(img);
}

function update(dat){
	dat=eval(dat);
	if(dat.length==0){
		return;
	}
	for(var i=0;i<dat.length;++i){
		if(dat[i][2]<=last){
			continue;
		}
		var tbl=$('#data')[0];
		var nR=tbl.insertRow(0);
		var nC;
		nC=nR.insertCell(0);
		nC.innerHTML=dat[i][0]+mkimg(dat[i][0],0,dat[i][3]);
		nC=nR.insertCell(1);
		nC.innerHTML=dat[i][1]+mkimg(dat[i][1],0,dat[i][4]);
		last=dat[i][2];
	}
	$.ajax({
		url: 'engine.php?action=fetch&last='+last,
		success: update
	});
}

function add(){
	$.post('engine.php',{
		action: 'add',
		text: $('#text').val(),
		last: last
	},update,"json");
}
</script>
</head>
<body>
<form>
<textarea id="text" onKeyup="dispGlyph()"></textarea>
<input type="button" value="Submit" onClick="add()" />
<div id="glyph"></div>
</form>
<hr />
<table id="data">
</table>
<script type="text/javascript">
	last=0;
	$.ajax({
		url: 'engine.php?action=fetch&last=0',
		success: update
	});
</script>
</body>
</html>
